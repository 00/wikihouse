<%inherit file="library.tmpl"/>

<%def name="sub_title()">${target.title}</%def>

<%def name="main_content()">
  <div id="design">
  <h4>
    ${target.key().id()}
    <a href="/library/design/${target.key().id()}" id="design-title">${escape(target.title)}</a>
  </h4>
  <%
    from urllib import quote
    user = users.get_current_user()
    is_user = user and bool(user.user_id() == target.user.user_id())
    is_admin = users.is_current_user_admin()
  %>
  % if target.status == u'approved' or is_admin or is_user:
    % if target.model_preview:
      <div class="preview">
        <img src="/blob/${target.model_preview.key()}" />
      </div>
    % endif
    % if target.model_preview_reverse:
      <div class="preview">
        <img src="/blob/${target.model_preview_reverse.key()}" />
      </div>
    % endif
    % if target.sheets_preview:
      <div class="preview">
        <img src="/blob/${target.sheets_preview.key()}" />
      </div>
    % endif
    <div class="series">
      <%
        i = 0
        l = len(target.series)
      %>
      % for s in target.series:
        <% i = i + 1 %>
        <a href="/library/series/${s.name()}">
          ${s.name().upper()}</a>${i < l and ', ' or ''}
      % endfor
    </div>
    <div class="user">
      by 
      <a href="/library/user/${target.user.user_id()}">
        ${escape(target.user.nickname())}</a>
    </div>
    <div class="verification">
      Verification: 
      % if target.verification == u'unverified':
        not structurally checked.
      % elif target.status == u'verified':
        structurally checked.
      % elif target.status == u'built':
        structurally checked, tested &amp; built.
      % endif
    </div>
    % if is_admin or is_user:
      % if target.notes:
        <div class="notes">
          Notes: ${target.notes}
        </div>
      % endif
      <div class="status">
        Moderation status: 
        % if target.status == u'pending':
          pending moderation.
        % elif target.status == u'rejected':
          rejected.
        % else:
          approved.
        % endif
      </div>
      % if is_admin and target.status == u'pending':
        <form class="moderation-form" action="/moderate" method="post">
          ${xsrf_input}
          <input type="hidden" name="id" value="${target.key().id()}" />
          <input type="submit" name="action" value="Approve" />
          <input type="submit" name="action" value="Reject" />
        </form>
      % endif
    % endif
    % if target.model:
      <div class="download model">
        <a href="/blob/${target.model.key()}/${quote(target.title)}.skp" title="Download SketchUp Model"
           id="design-download" rel="${target.component and '1' or '0'}">Download SketchUp Model</a>
      </div>
      <!--
        
        This link is just to show...
        
        
      -->
      <div class="hidden download base64 model">
        <a href="/blob64/${target.model.key()}"
           id="design-download-base64">Download Base64 Encoded</a>
        <textarea id="design-download-data"></textarea>
      </div>
    % endif
    % if target.sheets:
      <div class="download sheets">
        <a href="/blob/${target.sheets.key()}" title="Download CNC Cutting Sheets">
          Download CNC Cutting Sheets</a>
      </div>
    % endif
  % elif target.status == u'pending':
    <div class="status pending">
      This design is pending moderation.
    </div>
  % elif target.status == u'rejected':
    <div class="status pending">
      This design was rejected.
    </div>
  % endif
  <div class="comments row">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'wikihouse';
      var disqus_identifier = 'Design ${target.key().id()}';
      var disqus_url = '${request.path_url}';
      var disqus_developer = ${disqus_developer and '1' or '0'};
      var WIKIHOUSE_DOWNLOAD_PAGE = true;
    </script>
    <script type="text/javascript" src="//wikihouse.disqus.com/embed.js">
    </script>
    <noscript>
      Please enable JavaScript to view the 
      <a href="http://wikihouse.disqus.com/?ref_noscript">comments powered by Disqus</a>.
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  </div>
</%def>
